<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3c.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml">
<head>
<meta charset="utf8"/>
<meta http-equiv="pragma" content="no-cache"/>
<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.js"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
<meta name="apple-mobile-web-app-title" content="Year Clock"/>

<title>Rotate Map</title>
<script>
//. 鈴鹿サーキットの緯度経度（初期中心位置）
var lat = 34.8431714;
var lng = 136.5404776;

//. 初期ズームレベルと初期角度
var zoomlevel = 19;  //. Max:19
var deg = 0;
var speed = 10;

var map = null;

$(function(){
  activateDeviceEvent();

  //. keyboard
  document.body.onkeydown = function( e ){
    var keys = {
      37: 'left',
      38: 'up',
      39: 'right',
      40: 'down'
    };

    if( typeof keys[e.keyCode] != 'undefined' ){
      switch( keys[e.keyCode] ){
      case 'up':
        go();
        break;
      default:
        break;
      }
    }
  };

  //. 初期位置を中心とした地図を OpenStreetMap データで表示
  map = L.map('demoMap', { dragging: false, zoomControl: false, minZoom: zoomlevel, maxZoom: zoomlevel }).setView( [ lat, lng ], zoomlevel );
  L.tileLayer(
    'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data &copy; <a href="http://openstreetmap.org/">OpenStreetMap</a>',
      maxZoom: zoomlevel
    }
  ).addTo( map );

  //setInterval( rotateMap, 1000 );
});

function activateDeviceEvent(){
	if( window.DeviceOrientationEvent ){
      //. for iOS13
      if( window.DeviceOrientationEvent.requestPermission && typeof window.DeviceOrientationEvent.requestPermission === 'function' ){
        window.DeviceOrientationEvent.requestPermission();
      }
	    window.addEventListener( "deviceorientation", deviceOrientation );
	}
}

function deviceOrientation( e ) {
	e.preventDefault();

	var tiltLR = e.gamma;
	//var tiltFB = e.beta;
	//var dir = e.alpha;
  rotateMap( tiltLR );
}

function rotateMap( tiltLR ){
  if( tiltLR === null ){
    deg = ( deg + 10 ) % 360;
  }else{
    deg = tiltLR;
  }
  $('#demoMap').css( 'transform', 'rotate(-'+deg+'deg)' );
  $('#me').html( deg );
}

function go(){
  var z = deg * Math.PI / 360;
  lat += 0.0001 * Math.sin( z );
  lng += 0.0001 * Math.cos( z );
  map.panTo( new L.LatLng( lat, lng ) );
}
</script>
<style>
html, body, #wrapper {
	width: 100%;
	height: 100%;
	padding: 0px;
	margin: 0px;
}
#demoMap {
  position: fixed;
	width: 100%;
	height: 100%;
  //left: -50%;
  //top: -50%;
}
#me{
  z-index: 2;
  position: absolute;
  color: #ff0000;
  font-size: 36pt;
  left: 50%;
  top: 50%;
}
</style>
</head>
<body>
  <div id="demoMap"></div>
  <div id="me"></div>
</body>
</html>
